<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scrcpy GUI v3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* Default: Ultraviolet */
            --bg-color: #0c0c0e;
            --glass-bg: rgba(24, 24, 27, 0.7);
            --accent-primary: #bc6ff1;
            --accent-secondary: #892cdc;
            --accent-glow: rgba(188, 111, 241, 0.4);
            --accent-soft: rgba(188, 111, 241, 0.1);
            --text-main: #f1f5f9;
            --text-muted: #71717a;
            --border-color: rgba(188, 111, 241, 0.15);
            --input-bg: #0c0c0e;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; transition: background-color 0.3s ease; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--border-color); }
        
        .btn-primary { background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); color: #ffffff; transition: all 0.2s ease; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px var(--accent-glow); }
        
        .btn-stop { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #ffffff; transition: all 0.2s ease; }
        .btn-stop:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-color); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        
        kbd { background-color: #18181b; border-radius: 4px; padding: 2px 5px; font-family: monospace; font-size: 0.7rem; border: 1px solid #27272a; color: #a1a1aa; }
        input[type="number"], input[type="text"], select { background: var(--input-bg); border: 1px solid #27272a; border-radius: 4px; padding: 6px 10px; color: var(--text-main); outline: none; transition: border-color 0.2s; }
        input:focus, select:focus { border-color: var(--accent-primary); }
        
        .animate-spin-custom { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        .social-link { transition: all 0.2s ease; cursor: pointer; }
        .social-link:hover { transform: translateY(-2px); color: var(--accent-primary); }
        
        .tab-btn { transition: all 0.2s; border-bottom: 2px solid transparent; opacity: 0.6; color: var(--text-muted); }
        .tab-btn.active { border-color: var(--accent-primary); color: var(--accent-primary); opacity: 1; }
        
        .recent-item { transition: all 0.15s ease; cursor: pointer; border: 1px solid var(--accent-soft); }
        .recent-item:hover { background: var(--accent-soft); border-color: var(--accent-glow); color: var(--accent-primary); }
        
        #dropZone { border: 2px dashed var(--accent-soft); transition: all 0.2s ease; }
        #dropZone.drag-active { border-color: var(--accent-primary); background: var(--accent-soft); transform: scale(1.01); }
        
        /* Box Tooltips */
        .hint-box { position: relative; display: inline-flex; }
        .hint-content { 
            visibility: hidden; width: 220px; background: #18181b; color: #e4e4e7; text-align: left; 
            border-radius: 10px; padding: 12px; position: absolute; z-index: 100; bottom: 140%; left: 50%; 
            transform: translateX(-50%); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid var(--accent-glow); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); 
            font-size: 11px; line-height: 1.5; font-weight: 400; text-transform: none; pointer-events: none;
        }
        .hint-content::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: var(--accent-glow) transparent transparent transparent; }
        .hint-box:hover .hint-content { visibility: visible; opacity: 1; bottom: 120%; }

        /* Theme Selector Styling */
        .theme-select {
            background: #18181b; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 20px; padding: 4px 12px; font-size: 10px; font-weight: 700;
            text-transform: uppercase; color: #ffffff; cursor: pointer; outline: none;
            appearance: none; -webkit-appearance: none;
        }
        .theme-select option { background: #18181b; color: #ffffff; }
        .theme-select:hover { border-color: var(--accent-primary); }
    </style>
</head>
<body class="p-4 md:p-6 min-h-screen flex flex-col">
    <div class="w-full max-w-7xl mx-auto space-y-6 flex-grow">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 px-2">
            <div class="flex-1">
                <h1 class="text-xl md:text-2xl font-bold tracking-tight">scrcpy <span style="color: var(--accent-primary)">GUI</span> <span class="text-white text-[10px] align-top ml-0.5 font-bold tracking-tighter">by KB</span></h1>
                <p class="text-zinc-500 text-[10px] md:text-xs uppercase tracking-widest font-medium">Mirror & Control Android Devices Easily</p>
            </div>

            <!-- THEME SWITCHER -->
            <div class="flex-1 flex justify-center">
                <div class="glass px-4 py-1.5 rounded-full flex items-center gap-3">
                    <span class="text-[9px] uppercase font-black text-zinc-500 tracking-tighter">Theme</span>
                    <select id="themeSelector" class="theme-select" onchange="applyTheme(this.value)">
                        <option value="ultraviolet">Ultraviolet</option>
                        <option value="astro">Astro Blue</option>
                        <option value="carbon">Carbon Stealth</option>
                        <option value="emerald">Emerald Stealth</option>
                        <option value="bloodmoon">Blood Moon</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 items-center flex-1 justify-end">
                <div class="glass px-4 py-2 rounded-xl flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                    <div class="flex flex-col">
                        <span class="text-[10px] uppercase font-bold text-zinc-500 mb-1">Binary Status</span>
                        <div id="pathDisplay" class="text-xs font-mono font-bold text-yellow-500 truncate max-w-[150px] md:max-w-none">Checking...</div>
                        <div id="downloadProgressContainer" class="hidden w-full bg-zinc-800 h-1 rounded-full mt-1 overflow-hidden">
                            <div id="downloadProgressBar" class="bg-white h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center border-l border-zinc-800 pl-3">
                        <button id="downloadBinaryBtn" onclick="startDownload()" class="hidden px-2 py-0.5 bg-white/10 border border-white/20 rounded-md text-[9px] font-black text-zinc-200 hover:bg-white hover:text-black transition-all uppercase tracking-tighter shadow-sm animate-pulse">Download</button>
                        <button id="setPath" class="p-1 hover:text-white text-zinc-500 transition-colors" title="Select Folder"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></button>
                        <button id="resetPath" class="p-1 hover:text-red-400 text-zinc-500 transition-colors" title="Reset Path"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- SECTION 1: Left Sidebar -->
            <aside class="lg:col-span-3 space-y-4">
                <div class="glass p-5 rounded-2xl space-y-4">
                    <div class="flex justify-between items-center border-b border-zinc-800 pb-3">
                        <h2 class="text-sm font-bold uppercase tracking-tight flex items-center gap-2" style="color: var(--accent-primary)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                            Devices
                        </h2>
                        <div class="flex gap-3 items-center">
                            <button id="killAdb" class="text-[10px] text-zinc-500 hover:text-red-400 uppercase font-black transition-colors" title="Force kill all adb operations">Kill ADB</button>
                            <button id="refreshDevices" class="flex items-center gap-1 text-xs uppercase font-bold transition-colors" style="color: var(--accent-primary)">
                                <svg id="refreshIcon" xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Refresh
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-[10px] text-zinc-500 uppercase font-black">Active Device Selection</label>
                            <button onclick="renameDevice()" class="text-[9px] text-zinc-400 hover:text-white uppercase font-bold">Set Nickname</button>
                        </div>
                        <select id="deviceList" class="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-zinc-200 outline-none focus:border-white"><option value="">Searching...</option></select>
                    </div>
                    <div class="flex border-b border-zinc-800">
                        <button onclick="switchTab('usb')" id="tab-usb" class="tab-btn active flex-1 py-2 text-[10px] font-bold uppercase tracking-wider">USB</button>
                        <button onclick="switchTab('wireless')" id="tab-wireless" class="tab-btn flex-1 py-2 text-[10px] font-bold uppercase tracking-wider">Wireless</button>
                    </div>
                    
                    <div id="usb-view" class="space-y-3">
                        <div class="bg-white/5 border border-white/10 rounded-xl p-3 space-y-2">
                            <p class="text-[10px] font-bold uppercase flex items-center gap-1.5" style="color: var(--accent-primary)"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>USB Setup Tip</p>
                            <p class="text-[10px] text-zinc-500 leading-relaxed italic">Enable <span class="text-zinc-200 font-bold">Developer Options</span> and <span class="text-zinc-200 font-bold">USB Debugging</span> on your phone.</p>
                        </div>
                    </div>

                    <div id="wireless-view" class="hidden space-y-4">
                        <div class="space-y-2">
                            <label class="text-[11px] uppercase font-bold border-b border-zinc-800 w-full block pb-1" style="color: var(--accent-primary)">1. Connection</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="wirelessIp" placeholder="192.168.1.x:5555" class="w-full text-sm text-zinc-200">
                                <label class="flex items-center gap-1.5 cursor-pointer whitespace-nowrap">
                                    <input type="checkbox" id="autoConnect" class="rounded border-zinc-700 bg-zinc-950 text-white focus:ring-white w-3 h-3 accent-white">
                                    <span class="text-[9px] text-zinc-500 font-bold uppercase">Auto</span>
                                </label>
                            </div>
                            <button id="connectWireless" class="w-full py-2 bg-zinc-800 hover:bg-zinc-700 text-white rounded-lg text-xs font-bold uppercase">Connect</button>
                            <div id="recentContainer" class="hidden mt-3 space-y-1.5">
                                <label class="text-[9px] text-zinc-500 uppercase font-bold tracking-widest">History</label>
                                <div id="recentList" class="flex flex-col gap-1"></div>
                            </div>
                        </div>
                        <div class="space-y-2 pt-2 border-t border-zinc-800">
                            <label class="text-[11px] uppercase font-bold mb-1 block" style="color: var(--accent-primary)">2. Pairing (Android 11+)</label>
                            <div id="manualPairSection" class="space-y-2">
                                <input type="text" id="pairIp" placeholder="IP:Port" class="w-full text-sm text-zinc-200 mb-1">
                                <input type="text" id="pairCode" placeholder="Code" class="w-full text-sm text-zinc-200 mb-1">
                                <button id="pairBtn" class="w-full py-2 border border-zinc-700 text-zinc-400 hover:text-white rounded-lg text-xs font-bold uppercase">Pair</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dropZone" class="glass p-6 rounded-2xl flex flex-col items-center justify-center space-y-2 cursor-pointer hover:bg-white/5 transition-all border-2 border-dashed border-white/5 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 group-hover:scale-110 transition-transform" style="color: var(--accent-primary)" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg>
                    <div class="text-center">
                        <h3 class="text-sm font-bold text-zinc-200 uppercase tracking-tight">Quick Push / Install</h3>
                        <p class="text-[10px] text-zinc-500 italic mt-1 leading-tight px-2">Drag & drop <b>any file</b> or APK to push to phone</p>
                    </div>
                    <input type="file" id="apkInput" class="hidden">
                </div>
            </aside>

            <!-- SECTION 2: Center Workspace -->
            <main class="lg:col-span-6 space-y-6">
                <div class="glass p-5 rounded-2xl space-y-4 border border-zinc-800">
                    <label class="text-xs font-black text-white uppercase tracking-tighter mb-2 block">Select Mirroring Source 
                        <span class="hint-box ml-1">
                            <span class="cursor-help" style="color: var(--accent-primary)">(?)</span>
                            <span class="hint-content">Choose between standard screen mirroring, high-speed camera view, or independent desktop mode.</span>
                        </span>
                    </label>
                    <select id="sessionMode" class="w-full bg-zinc-950 border-2 border-zinc-800 rounded-xl px-4 py-3 text-lg font-bold text-white focus:border-white outline-none appearance-none cursor-pointer">
                        <option value="mirror" selected>Screen Mirroring</option>
                        <option value="camera">Camera Mirroring</option>
                        <option value="desktop">Desktop Mode (Android 16+)</option>
                    </select>
                </div>

                <div id="enginePanel" class="glass p-6 rounded-2xl space-y-4 transition-all duration-300">
                    <div class="flex justify-between items-center border-b border-zinc-800 pb-3">
                        <h2 class="text-sm font-bold uppercase text-zinc-300">Engine Configuration</h2>
                        <span id="mirrorStatus" class="text-[9px] font-bold uppercase tracking-wider bg-emerald-500/10 px-2 py-0.5 rounded text-emerald-500">Active</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div id="otgWrapper" class="p-3 bg-zinc-950/50 rounded-xl border border-zinc-800 space-y-3">
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" id="otgEnabled" class="rounded text-white accent-white">
                                <span class="text-xs font-bold text-white uppercase tracking-tight">Enable HID Input (OTG Style)</span>
                            </label>
                            <div id="otgSubOptions" class="pl-7 hidden space-y-2">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="otgPure" class="rounded text-red-500 accent-red-600">
                                    <span class="text-[10px] text-zinc-400 uppercase font-bold">Pure OTG Mode (No Mirroring) 
                                        <span class="hint-box ml-1">
                                            <span class="cursor-help" style="color: var(--accent-primary)">(?)</span>
                                            <span class="hint-content">Only sends keyboard/mouse input. No window will appear. Press ALT to release mouse. (Wireless uses UHID emulation).</span>
                                        </span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div id="videoControls" class="space-y-4 transition-all">
                            <div id="cameraSettings" class="hidden p-4 bg-zinc-950/40 rounded-xl border border-white/5 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2"><label class="text-[10px] uppercase font-black" style="color: var(--accent-primary)">Camera Facing</label><select id="cameraFacing" class="w-full text-xs text-zinc-200"><option value="back">Back Camera</option><option value="front">Front Camera</option><option value="external">External (USB)</option></select></div>
                                    <div class="space-y-2"><label class="text-[10px] uppercase font-black" style="color: var(--accent-primary)">Specific ID 
                                        <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Manual sensor ID. Use 'List Cameras' to find IDs for ultra-wide or macro lenses.</span></span>
                                    </label><input type="text" id="cameraId" placeholder="e.g. 0, 2" class="w-full text-xs text-zinc-200"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="space-y-2"><label class="text-[10px] uppercase font-black" style="color: var(--accent-primary)">Video Codec</label><select id="codec" class="w-full text-xs text-zinc-200"><option value="h264">H.264 (Default)</option><option value="h265">H.265 (HEVC)</option><option value="av1">AV1</option></select></div>
                                    <div class="space-y-2"><label class="text-[10px] uppercase font-black" style="color: var(--accent-primary)">Aspect Ratio 
                                        <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Controls the camera feed shape. 4:3 is standard photography, 16:9 is widescreen video.</span></span>
                                    </label><select id="cameraAr" class="w-full text-xs text-zinc-200"><option value="0">Default</option><option value="4:3">4:3 (Standard)</option><option value="16:9">16:9 (Widescreen)</option></select></div>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="flex items-center gap-3 cursor-pointer group">
                                        <input type="checkbox" id="cameraHighSpeed" class="rounded text-white accent-white">
                                        <span class="text-[10px] text-zinc-300 font-bold uppercase tracking-tight">High Speed Sensor 
                                            <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Unlocks 120 FPS+ for slow-motion capture. Requires hardware support. H.265 codec is recommended.</span></span>
                                        </span>
                                    </label>
                                    <div class="flex gap-2">
                                        <button id="listCamInfo" class="py-1 px-2 bg-zinc-800 hover:bg-zinc-700 rounded text-[9px] font-bold uppercase border border-zinc-700" style="color: var(--accent-primary)">List Cameras</button>
                                        <button id="listCamSizes" class="py-1 px-2 bg-zinc-800 hover:bg-zinc-700 rounded text-[9px] font-bold uppercase border border-zinc-700" style="color: var(--accent-primary)">List Sizes</button>
                                    </div>
                                </div>
                            </div>

                            <div id="desktopSettings" class="hidden p-4 bg-zinc-950/40 rounded-xl border border-white/5 space-y-3">
                                <label class="text-[11px] uppercase font-black tracking-tight" style="color: var(--accent-primary)">Virtual Display Resolution 
                                    <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Desktop Mode creates an independent virtual workspace.</span></span>
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div class="space-y-1"><label class="text-[9px] text-zinc-500 font-bold">W</label><input type="number" id="vdWidth" value="1920" class="w-full text-xs"></div>
                                    <div class="space-y-1"><label class="text-[9px] text-zinc-500 font-bold">H</label><input type="number" id="vdHeight" value="1080" class="w-full text-xs"></div>
                                    <div class="space-y-1"><label class="text-[9px] text-zinc-500 font-bold">DPI</label><input type="number" id="vdDpi" value="420" class="w-full text-xs"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div id="resLimitWrapper" class="space-y-2"><label class="text-[11px] text-zinc-400 uppercase font-bold">Resolution Limit</label><select id="resolution" class="w-full text-sm text-zinc-200"><option value="0" selected>Original</option><option value="3840">4K</option><option value="2560">2K</option><option value="1920">1080p</option><option value="1280">720p</option></select></div>
                                <div class="space-y-2"><label class="text-[11px] text-zinc-400 uppercase font-bold">FPS Limit</label><select id="fps" class="w-full text-sm text-zinc-200"><option value="30">30</option><option value="60" selected>60</option><option value="90">90</option><option value="120">120</option></select></div>
                            </div>
                            <div class="space-y-2">
                                <label class="text-[11px] text-zinc-400 uppercase font-bold flex justify-between">Bitrate <span id="bitrateVal" class="text-white font-bold">8 Mbps</span></label>
                                <input type="range" id="bitrate" min="1" max="24" value="8" class="w-full h-2 accent-white bg-zinc-800 rounded-lg">
                            </div>
                            <div id="rotationWrapper" class="space-y-2"><label class="text-[11px] text-zinc-400 uppercase font-bold">Orientation</label><select id="rotation" class="w-full text-sm text-zinc-200"><option value="0">Default</option><option value="90">90° CCW</option><option value="180">180°</option><option value="270">90° CW</option></select></div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <button id="startScrcpy" class="btn-primary w-full py-5 rounded-2xl text-lg font-bold uppercase shadow-2xl tracking-widest transition-all">Launch Mirroring</button>
                    <div id="logOutput" class="glass p-4 rounded-2xl h-40 overflow-y-auto custom-scrollbar font-mono text-xs text-zinc-300 border border-white/5"><div class="font-bold border-b border-zinc-800 mb-2 pb-1" style="color: var(--accent-primary)">[SYSTEM READY]</div></div>
                </div>
            </main>

            <!-- SECTION 3: Right Sidebar -->
            <aside class="lg:col-span-3 space-y-4">
                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-sm font-bold uppercase text-zinc-300 border-b border-zinc-800 pb-3">Session Behavior</h2>
                    <div class="space-y-3 pt-2">
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="stayAwake" class="rounded text-white accent-white" checked><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Stay Awake <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Prevents phone from sleeping.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="turnOff" class="rounded text-white accent-white"><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Screen Off <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Turns off physical screen.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="audioEnabled" class="rounded text-white accent-white" checked><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Enable Audio <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Forward audio to PC.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="alwaysOnTop" class="rounded text-white accent-white"><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Always On Top <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Keep above other windows.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="fullscreen" class="rounded text-white accent-white"><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Full Screen <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Start in full screen.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="borderless" class="rounded text-white accent-white"><span class="text-xs text-zinc-300 group-hover:text-white transition-colors">Borderless <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">No window frame.</span></span></span></label>
                        <label class="flex items-center gap-3 cursor-pointer group"><input type="checkbox" id="recordScreen" class="rounded text-red-500 accent-red-600"><span class="text-xs text-red-400 font-bold">Record Feed <span class="hint-box ml-1"><span class="cursor-help" style="color: var(--accent-primary)">(?)</span><span class="hint-content">Save session to MKV.</span></span></span></label>
                    </div>
                    <div id="recPathPanel" class="mt-4 pt-4 border-t border-zinc-800 space-y-3">
                        <div class="flex flex-col">
                            <label class="text-[10px] text-white uppercase font-bold tracking-tight">Save Recordings To</label>
                            <div id="recPathDisplay" class="text-[9px] font-mono text-zinc-500 mt-1 truncate hover:text-white cursor-pointer">Videos Folder</div>
                        </div>
                        <button id="setRecPath" class="w-full flex items-center justify-center gap-2 py-2 bg-zinc-800 hover:bg-zinc-700 rounded text-[10px] font-bold text-white uppercase transition-colors">Change Location</button>
                    </div>
                </div>

                <div class="glass p-5 rounded-2xl space-y-4">
                    <h2 class="text-xs font-bold uppercase border-b border-zinc-800 pb-3" style="color: var(--accent-primary)">Shortcuts (Alt + Key)</h2>
                    <div class="grid grid-cols-2 gap-2 text-[11px] text-zinc-300">
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Full</span><kbd>F</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Home</span><kbd>H</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Back</span><kbd>B</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Recents</span><kbd>S</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Power</span><kbd>P</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Rotate</span><kbd>R</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Paste</span><kbd>V</kbd></div>
                        <div class="bg-zinc-950/30 p-1.5 rounded-lg border border-zinc-800 flex justify-between"><span>Off</span><kbd>O</kbd></div>
                    </div>
                </div>
            </aside>
        </div>

        <footer class="mt-12 mb-8 text-center w-full">
            <div class="glass px-6 py-10 rounded-3xl border-zinc-800 w-full">
                <h2 class="text-xs font-bold uppercase tracking-[0.3em] mb-4" style="color: var(--accent-primary)">About Scrcpy GUI</h2>
                <div class="flex justify-center items-center gap-12 mb-8">
                    <button onclick="openLink('https://github.com/kil0bit-kb')" class="social-link flex flex-col items-center gap-1.5 group text-zinc-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
                        <span class="text-[10px] uppercase font-bold tracking-widest">GitHub</span>
                    </button>
                    <button onclick="openLink('https://www.youtube.com/@kilObit')" class="social-link flex flex-col items-center gap-1.5 group text-zinc-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        <span class="text-[10px] uppercase font-bold tracking-widest">YouTube</span>
                    </button>
                    <button onclick="openLink('https://kil0bit.blogspot.com/')" class="social-link flex flex-col items-center gap-1.5 group text-zinc-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" /></svg>
                        <span class="text-[10px] uppercase font-bold tracking-widest">Website</span>
                    </button>
                </div>
                <p class="text-[10px] text-zinc-500 uppercase tracking-[0.2em] font-bold">App Version v3.0 • Created with ❤️ by <b>KB</b></p>
            </div>
        </footer>
    </div>

    <script>
        const themes = {
            ultraviolet: { bg: '#0c0c0e', glass: 'rgba(24, 24, 27, 0.7)', accent: '#bc6ff1', accentSec: '#892cdc', glow: 'rgba(188, 111, 241, 0.4)', soft: 'rgba(188, 111, 241, 0.1)', text: '#f1f5f9' },
            astro: { bg: '#020617', glass: 'rgba(15, 23, 42, 0.7)', accent: '#06b6d4', accentSec: '#0891b2', glow: 'rgba(6, 182, 212, 0.4)', soft: 'rgba(6, 182, 212, 0.1)', text: '#f1f5f9' },
            carbon: { bg: '#09090b', glass: 'rgba(24, 24, 27, 0.7)', accent: '#ffffff', accentSec: '#a1a1aa', glow: 'rgba(255, 255, 255, 0.1)', soft: 'rgba(255, 255, 255, 0.05)', text: '#f1f5f9' },
            emerald: { bg: '#09090b', glass: 'rgba(24, 24, 27, 0.7)', accent: '#10b981', accentSec: '#059669', glow: 'rgba(16, 185, 129, 0.4)', soft: 'rgba(16, 185, 129, 0.1)', text: '#f1f5f9' },
            bloodmoon: { bg: '#0a0000', glass: 'rgba(20, 0, 0, 0.7)', accent: '#ef4444', accentSec: '#991b1b', glow: 'rgba(239, 68, 68, 0.4)', soft: 'rgba(239, 68, 68, 0.1)', text: '#f1f5f9' }
        };

        function applyTheme(themeName) {
            const t = themes[themeName] || themes.ultraviolet;
            const root = document.documentElement;
            root.style.setProperty('--bg-color', t.bg);
            root.style.setProperty('--glass-bg', t.glass);
            root.style.setProperty('--accent-primary', t.accent);
            root.style.setProperty('--accent-secondary', t.accentSec);
            root.style.setProperty('--accent-glow', t.glow);
            root.style.setProperty('--accent-soft', t.soft);
            root.style.setProperty('--text-main', t.text);
            root.style.setProperty('--input-bg', t.bg);
            localStorage.setItem('scrcpy_gui_theme', themeName);
            document.getElementById('themeSelector').value = themeName;
        }

        async function startDownload() {
            addLog("Preparing download...", 'info');
            const bridge = getBridge();
            if (!bridge) return addLog("Bridge not available yet. Please wait.", 'error');
            document.getElementById('downloadBinaryBtn').classList.add('hidden');
            document.getElementById('downloadProgressContainer').classList.remove('hidden');
            document.getElementById('downloadProgressBar').style.width = '0%';
            try { await bridge.DownloadScrcpy(); } catch (e) { addLog("Failed to start downloader: " + e.message, 'error'); document.getElementById('downloadBinaryBtn').classList.remove('hidden'); }
        }

        function getBridge() { return window.chrome?.webview?.hostObjects?.bridge; }
        const isElectron = typeof require !== 'undefined';
        function checkSupported() { return isElectron || !!getBridge(); }

        let ipcRenderer;
        if (isElectron) {
            ipcRenderer = require('electron').ipcRenderer;
        } else {
            ipcRenderer = {
                invoke: async (channel, ...args) => {
                    const bridge = getBridge();
                    if (!bridge) return { error: true, message: 'Bridge not found' };
                    try {
                        switch (channel) {
                            case 'get-devices': return JSON.parse(await bridge.GetDevices(args[0]));
                            case 'check-scrcpy': return JSON.parse(await bridge.CheckScrcpy(args[0]));
                            case 'adb-connect': return JSON.parse(await bridge.AdbConnect(JSON.stringify(args[0])));
                            case 'adb-pair': return JSON.parse(await bridge.AdbPair(JSON.stringify(args[0])));
                            case 'install-apk': return JSON.parse(await bridge.InstallApk(JSON.stringify(args[0])));
                            case 'push-file': return JSON.parse(await bridge.PushFile(JSON.stringify(args[0])));
                            case 'adb-shell': return JSON.parse(await bridge.AdbShell(args[0].customPath, args[0].device, args[0].cmd));
                            case 'take-shot': return JSON.parse(await bridge.TakeScreenshot(args[0].customPath, args[0].device));
                            case 'select-folder': return await bridge.SelectFolder();
                            case 'get-default-video-path': return await bridge.GetDefaultVideoPath();
                            case 'get-camera-info': return JSON.parse(await bridge.GetCameraInfo(args[0].customPath, args[0].device));
                            case 'get-camera-sizes': return JSON.parse(await bridge.GetCameraSizes(args[0].customPath, args[0].device, args[0].facing));
                            case 'kill-adb': return JSON.parse(await bridge.KillAdb(args[0]));
                            default: return null;
                        }
                    } catch (e) { return { error: true, message: e.message }; }
                },
                send: async (channel, ...args) => {
                    const bridge = getBridge();
                    if (!bridge) return;
                    try {
                        switch (channel) {
                            case 'run-scrcpy': await bridge.RunScrcpy(JSON.stringify(args[0])); break;
                            case 'stop-scrcpy': await bridge.StopScrcpy(args[0]); break;
                            case 'open-path': await bridge.OpenPath(args[0]); break;
                        }
                    } catch (e) {}
                },
                on: (channel, callback) => {
                    window.addEventListener('ipc-message', (e) => { if (e.detail.channel === channel) callback(null, e.detail.data); });
                }
            };
        }

        if (window.chrome?.webview) {
            window.chrome.webview.addEventListener('message', event => {
                const data = event.data;
                let channel = null;
                if (data.type === 'log') channel = 'scrcpy-log';
                if (data.type === 'status') channel = 'scrcpy-status';
                if (channel) window.dispatchEvent(new CustomEvent('ipc-message', { detail: { channel, data: data.type === 'log' ? data.message : data } }));
                if (data.type === 'download-progress') document.getElementById('downloadProgressBar').style.width = data.percent + '%';
                if (data.type === 'downloading') { addLog(data.message, data.success ? 'info' : 'error'); if (!data.success) { document.getElementById('downloadBinaryBtn').classList.remove('hidden'); document.getElementById('downloadProgressContainer').classList.add('hidden'); } }
                if (data.type === 'download-complete') { document.getElementById('downloadProgressContainer').classList.add('hidden'); customScrcpyPath = data.message; localStorage.setItem('scrcpyPath', customScrcpyPath); addLog("Scrcpy binaries installed successfully!", 'success'); validateScrcpy(); }
            });
        }

        const PERSIST_KEY = 'scrcpy_gui_v3_final', HISTORY_KEY = 'scrcpy_gui_recent_ips', NICKNAME_KEY = 'scrcpy_device_nicknames';
        const activeSessions = new Set();
        let customScrcpyPath = localStorage.getItem('scrcpyPath') || null, recordPath = localStorage.getItem('recordPath') || null;
        const inputIds = ['sessionMode', 'resolution', 'fps', 'bitrate', 'rotation', 'cameraFacing', 'cameraId', 'codec', 'cameraAr', 'cameraHighSpeed', 'vdWidth', 'vdHeight', 'vdDpi', 'stayAwake', 'turnOff', 'audioEnabled', 'alwaysOnTop', 'fullscreen', 'borderless', 'recordScreen', 'otgEnabled', 'otgPure', 'autoConnect'];
        const logEl = document.getElementById('logOutput'), bitrateSlider = document.getElementById('bitrate'), bitrateVal = document.getElementById('bitrateVal'), pathDisplay = document.getElementById('pathDisplay'), startBtn = document.getElementById('startScrcpy'), refreshBtn = document.getElementById('refreshDevices'), refreshIcon = document.getElementById('refreshIcon'), sessionSelect = document.getElementById('sessionMode'), otgCheck = document.getElementById('otgEnabled'), otgPure = document.getElementById('otgPure'), otgWrapper = document.getElementById('otgWrapper'), downloadBinaryBtn = document.getElementById('downloadBinaryBtn'), deviceList = document.getElementById('deviceList'), dropZone = document.getElementById('dropZone'), apkInput = document.getElementById('apkInput'), wirelessIp = document.getElementById('wirelessIp');

        function renameDevice() { const dev = deviceList.value; if (!dev) return; const nick = prompt(`Enter nickname for ${dev}:`); if (nick !== null) { const nicks = JSON.parse(localStorage.getItem(NICKNAME_KEY) || '{}'); nicks[dev] = nick; localStorage.setItem(NICKNAME_KEY, JSON.stringify(nicks)); scanDevices(); } }
        function saveSettings() { const settings = {}; inputIds.forEach(id => { const el = document.getElementById(id); if (el) settings[id] = el.type === 'checkbox' ? el.checked : el.value; }); settings['wirelessIpVal'] = wirelessIp.value; localStorage.setItem(PERSIST_KEY, JSON.stringify(settings)); }
        async function loadSettings() { applyTheme(localStorage.getItem('scrcpy_gui_theme') || 'ultraviolet'); if (!recordPath && checkSupported()) { try { recordPath = await ipcRenderer.invoke('get-default-video-path'); localStorage.setItem('recordPath', recordPath); } catch(e) {} } if(document.getElementById('recPathDisplay') && recordPath) document.getElementById('recPathDisplay').textContent = recordPath; const saved = localStorage.getItem(PERSIST_KEY); if (saved) { try { const s = JSON.parse(saved); inputIds.forEach(id => { const el = document.getElementById(id); if(!el || s[id] === undefined) return; if(el.type === 'checkbox') el.checked = s[id]; else el.value = s[id]; }); if (s['wirelessIpVal']) wirelessIp.value = s['wirelessIpVal']; } catch (e) {} } updateModeUI(); updateRecentList(); if(bitrateSlider && bitrateVal) bitrateVal.textContent = bitrateSlider.value + ' Mbps'; }
        function updateRecentList() { const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); const container = document.getElementById('recentList'), parent = document.getElementById('recentContainer'); if (history.length === 0) { parent.classList.add('hidden'); return; } parent.classList.remove('hidden'); container.innerHTML = ''; history.forEach(ip => { const div = document.createElement('div'); div.className = 'recent-item px-3 py-1.5 rounded bg-zinc-900/50 text-[10px] font-mono text-zinc-400 flex justify-between items-center group'; div.innerHTML = `<span>${ip}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-0 group-hover:opacity-100 transition-opacity" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>`; div.onclick = () => { wirelessIp.value = ip; saveSettings(); }; container.appendChild(div); }); }
        function addToHistory(ip) { if (!ip || ip.trim() === "") return; let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); history = history.filter(item => item !== ip); history.unshift(ip); localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, 5))); updateRecentList(); }
        function updateModeUI() {
            const mode = sessionSelect.value, otg = otgCheck.checked, pure = otgPure.checked;
            const camBlock = document.getElementById('cameraSettings'), videoControls = document.getElementById('videoControls'), deskBlock = document.getElementById('desktopSettings'), mirrorStatus = document.getElementById('mirrorStatus'), otgSub = document.getElementById('otgSubOptions'), resLimitWrapper = document.getElementById('resLimitWrapper');
            if(otgWrapper) otgWrapper.classList.toggle('hidden', mode !== 'mirror');
            if(otgSub) otgSub.classList.toggle('hidden', !otg);
            if(camBlock) camBlock.classList.toggle('hidden', mode !== 'camera');
            if(deskBlock) deskBlock.classList.toggle('hidden', mode !== 'desktop');
            if(resLimitWrapper) resLimitWrapper.classList.toggle('hidden', mode === 'desktop');
            if (mode === 'mirror' && otg && pure) { videoControls.classList.add('opacity-40', 'pointer-events-none'); mirrorStatus.textContent = "Mirroring Disabled"; mirrorStatus.className = "text-[9px] font-bold text-red-400 bg-red-500/10 px-2 py-0.5 rounded"; document.getElementById('recordScreen').disabled = true; } 
            else { videoControls.classList.remove('opacity-40', 'pointer-events-none'); mirrorStatus.textContent = "Active"; mirrorStatus.className = "text-[9px] font-bold text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded"; document.getElementById('recordScreen').disabled = false; }
            const dev = deviceList.value;
            if (dev && activeSessions.has(dev)) { startBtn.textContent = 'Stop Session'; startBtn.className = 'btn-stop w-full py-5 rounded-2xl text-white text-lg font-bold uppercase transition-all'; } 
            else { let btnText = "Launch Mirroring"; if (mode === 'camera') btnText = "Launch Camera"; else if (mode === 'desktop') btnText = "Launch Desktop Mode"; else if (mode === 'mirror' && otg && pure) btnText = "Launch OTG Mode"; startBtn.textContent = btnText; startBtn.className = 'btn-primary w-full py-5 rounded-2xl text-white text-lg font-bold uppercase transition-all'; }
        }

        if(dropZone && apkInput) {
            dropZone.onclick = (e) => { if (e.target !== apkInput) apkInput.click(); };
            apkInput.onchange = async () => { if (apkInput.files.length > 0) { await handleFile(apkInput.files[0]); apkInput.value = ""; } };
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-active'); });
            dropZone.addEventListener('drop', async (e) => { e.preventDefault(); dropZone.classList.remove('drag-active'); if (e.dataTransfer.files.length > 0) await handleFile(e.dataTransfer.files[0]); });
        }

        async function handleFile(file) { if (!checkSupported()) return; const dev = deviceList.value; if (!dev) return addLog("Select a device first!", "error"); if (file.name.toLowerCase().endsWith('.apk')) { addLog(`Installing ${file.name}...`); const res = await ipcRenderer.invoke('install-apk', { device: dev, filePath: file.path, customPath: customScrcpyPath }); addLog(res.message, res.success ? 'success' : 'error'); } else { addLog(`Pushing ${file.name} to Download folder...`); const res = await ipcRenderer.invoke('push-file', { device: dev, filePath: file.path, customPath: customScrcpyPath }); addLog(res.message, res.success ? 'success' : 'error'); } }
        sessionSelect.onchange = () => { updateModeUI(); saveSettings(); };
        otgCheck.onchange = () => { updateModeUI(); saveSettings(); };
        otgPure.onchange = () => { updateModeUI(); saveSettings(); };
        document.getElementById('listCamSizes').onclick = async () => { const dev = deviceList.value; if (!dev) return addLog("Select a device first!", "error"); const facing = document.getElementById('cameraFacing').value; const res = await ipcRenderer.invoke('get-camera-sizes', { device: dev, customPath: customScrcpyPath, facing: facing }); if (res.success) res.output.split('\n').forEach(l => { if(l.trim()) addLog(l.trim(), 'success'); }); else addLog(res.message, 'error'); };
        document.getElementById('cameraHighSpeed').onchange = () => { if (document.getElementById('cameraHighSpeed').checked) { document.getElementById('fps').value = "120"; if (parseInt(bitrateSlider.value) < 16) { bitrateSlider.value = "20"; bitrateVal.textContent = "20 Mbps"; } } saveSettings(); };
        inputIds.forEach(id => { const el = document.getElementById(id); if (el && !['sessionMode','otgEnabled','otgPure'].includes(id)) { el.addEventListener('change', saveSettings); if (['range','number','text'].includes(el.type)) el.addEventListener('input', saveSettings); } });
        function addLog(msg, type = 'info') { const div = document.createElement('div'); div.className = {error:'text-red-400 border-l-2 border-red-500 pl-2 my-1', success:'border-l-2 border-zinc-100 pl-2 my-1', info:'text-zinc-300'}[type] || 'text-zinc-300'; if (type === 'success') div.style.color = 'var(--accent-primary)'; div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`; logEl.appendChild(div); logEl.scrollTop = logEl.scrollHeight; }
        async function scanDevices(targetIp = null) { if (!checkSupported()) return; refreshBtn.disabled = true; refreshIcon.classList.add('animate-spin-custom'); const result = await ipcRenderer.invoke('get-devices', customScrcpyPath); refreshBtn.disabled = false; refreshIcon.classList.remove('animate-spin-custom'); if (!result || result.error) return; const current = deviceList.value, nicks = JSON.parse(localStorage.getItem(NICKNAME_KEY) || '{}'); deviceList.innerHTML = result.devices.length ? '' : '<option value="">No devices detected</option>'; result.devices.forEach(id => { const o = document.createElement('option'); o.value = id; o.textContent = nicks[id] ? `${nicks[id]} (${id})` : id; deviceList.appendChild(o); }); if (result.devices.length) { const search = targetIp || current; const found = Array.from(deviceList.options).find(o => o.value.includes(search) && search !== ""); if (found) deviceList.value = found.value; else deviceList.selectedIndex = 0; } updateModeUI(); }
                        async function validateScrcpy() {
                            if (!checkSupported()) { 
                                pathDisplay.textContent = 'Preview Mode'; 
                                pathDisplay.className = 'text-xs font-mono font-bold text-zinc-500'; 
                                return; 
                            }
                            
                            try {
                                const result = await ipcRenderer.invoke('check-scrcpy', customScrcpyPath);
                                if (result) {
                                    pathDisplay.textContent = result.message; 
                                    pathDisplay.className = `text-xs font-mono font-bold ${result.found ? 'text-zinc-100' : 'text-red-400'}`;
                                    startBtn.disabled = !result.found; 
                                    if (downloadBinaryBtn) downloadBinaryBtn.classList.toggle('hidden', result.found);
                                    
                                    if (result.found) {
                                        const settings = JSON.parse(localStorage.getItem(PERSIST_KEY) || '{}');
                                        if (settings.autoConnect && settings.wirelessIpVal) {
                                            addLog(`Auto-connecting to ${settings.wirelessIpVal}...`);
                                            const connectRes = await ipcRenderer.invoke('adb-connect', { ip: settings.wirelessIpVal, customPath: customScrcpyPath });
                                            if (connectRes && connectRes.success) { addLog(connectRes.message, 'success'); setTimeout(() => scanDevices(settings.wirelessIpVal), 1000); } else { scanDevices(); }
                                        } else { scanDevices(); }
                                    }
                                } else {
                                    throw new Error("No result from backend");
                                }
                            } catch (e) {
                                pathDisplay.textContent = 'Search Failed';
                                pathDisplay.className = 'text-xs font-mono font-bold text-red-400';
                                if (downloadBinaryBtn) downloadBinaryBtn.classList.remove('hidden');
                                addLog("Scrcpy check failed: " + e.message, 'error');
                            }
                        }
                        document.getElementById('killAdb').onclick = async () => { if (checkSupported()) { await ipcRenderer.invoke('kill-adb', customScrcpyPath); addLog("ADB Cleared", "error"); activeSessions.clear(); scanDevices(); } };
        document.getElementById('connectWireless').onclick = async () => { const ip = wirelessIp.value.trim(); if (!ip) return; addLog(`Connecting to ${ip}...`); if (checkSupported()) { const res = await ipcRenderer.invoke('adb-connect', { ip, customPath: customScrcpyPath }); if (res && res.success) { addLog(res.message, 'success'); addToHistory(ip); saveSettings(); setTimeout(() => scanDevices(ip), 1000); } else if (res) addLog(res.message, 'error'); } };
        document.getElementById('pairBtn').onclick = async () => { const ip = document.getElementById('pairIp').value.trim(), code = document.getElementById('pairCode').value.trim(); if (!ip || !code) return addLog('IP and Code required', 'error'); if (checkSupported()) { const res = await ipcRenderer.invoke('adb-pair', { ip, code, customPath: customScrcpyPath }); if (res && res.success) { addLog('Pairing Successful! Connecting...', 'success'); const cleanIp = ip.split(':')[0] + ':5555'; wirelessIp.value = cleanIp; saveSettings(); document.getElementById('connectWireless').click(); } else if (res) addLog('Pairing Failed: ' + res.message, 'error'); } };
        document.getElementById('listCamInfo').onclick = async () => { const dev = deviceList.value; if (!dev) return addLog("Select a device first!", "error"); addLog(`Querying camera info for ${dev}...`); const res = await ipcRenderer.invoke('get-camera-info', { device: dev, customPath: customScrcpyPath }); if (res.success) res.output.split('\n').forEach(l => { if(l.trim()) addLog(l.trim(), 'success'); }); else addLog(res.message, 'error'); };
        bitrateSlider.oninput = () => { bitrateVal.textContent = bitrateSlider.value + ' Mbps'; saveSettings(); };
        refreshBtn.onclick = () => scanDevices();
        if (checkSupported()) {
            ipcRenderer.on('scrcpy-status', (e, { device, running }) => { if (running) activeSessions.add(device); else activeSessions.delete(device); updateModeUI(); });
            ipcRenderer.on('scrcpy-log', (e, msg) => addLog(msg));
        }
        document.getElementById('setPath').onclick = async () => { if (checkSupported()) { try { const p = await ipcRenderer.invoke('select-folder'); if (p) { customScrcpyPath = p; localStorage.setItem('scrcpyPath', p); validateScrcpy(); } } catch (e) {} } };
        document.getElementById('resetPath').onclick = () => { customScrcpyPath = null; localStorage.removeItem('scrcpyPath'); validateScrcpy(); };
        startBtn.onclick = () => {
            if (!checkSupported()) return;
            const dev = deviceList.value;
            if (!dev) return addLog("Select device!", "error");
            if (activeSessions.has(dev)) return ipcRenderer.send('stop-scrcpy', dev);
            ipcRenderer.send('run-scrcpy', {
                device: dev, sessionMode: sessionSelect.value, otgEnabled: otgCheck.checked, otgPure: otgPure.checked,
                res: document.getElementById('resolution').value, bitrate: parseInt(bitrateSlider.value), fps: document.getElementById('fps').value,
                stayAwake: document.getElementById('stayAwake').checked, turnOff: document.getElementById('turnOff').checked,
                audioEnabled: document.getElementById('audioEnabled').checked, alwaysOnTop: document.getElementById('alwaysOnTop').checked,
                fullscreen: document.getElementById('fullscreen').checked, borderless: document.getElementById('borderless').checked,
                record: document.getElementById('recordScreen').checked, cameraFacing: document.getElementById('cameraFacing').value,
                cameraId: document.getElementById('cameraId').value, codec: document.getElementById('codec').value,
                cameraAr: document.getElementById('cameraAr').value, cameraHighSpeed: document.getElementById('cameraHighSpeed').checked,
                vdWidth: document.getElementById('vdWidth').value, vdHeight: document.getElementById('vdHeight').value,
                vdDpi: document.getElementById('vdDpi').value, recordPath: localStorage.getItem('recordPath'),
                scrcpyPath: customScrcpyPath, rotation: document.getElementById('rotation').value
            });
        };
        document.getElementById('setRecPath').onclick = async () => { if (checkSupported()) { const p = await ipcRenderer.invoke('select-folder'); if (p) { localStorage.setItem('recordPath', p); document.getElementById('recPathDisplay').textContent = p; addLog("Record Path updated", "success"); } } };
        function switchTab(t) { document.getElementById('usb-view').classList.toggle('hidden', t !== 'usb'); document.getElementById('wireless-view').classList.toggle('hidden', t !== 'wireless'); document.getElementById('tab-usb').classList.toggle('active', t === 'usb'); document.getElementById('tab-wireless').classList.toggle('active', t === 'wireless'); }
        function openLink(u) { const bridge = getBridge(); if (isElectron) require('electron').shell.openExternal(u); else if (bridge) bridge.OpenPath(u); else window.open(u, '_blank'); }
        loadSettings(); validateScrcpy();
    </script>
</body>
</html>